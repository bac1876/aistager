
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
    <title>AiStager - AI Interior Design</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AiStager">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="description" content="Transform your spaces with AI-powered interior design and virtual staging">
    
    <!-- PWA Links -->
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icon-192.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/icon-512.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Dark mode base styles */
        body {
            background: linear-gradient(to bottom right, #0f0f0f, #1a1a1a);
            color: #e5e5e5;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* Floating card styles */
        .floating-card {
            background: rgba(31, 31, 31, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }
        
        .floating-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 48px rgba(0, 0, 0, 0.4);
            border-color: rgba(59, 130, 246, 0.3);
        }
        
        /* Modern input styles */
        input[type="text"], input[type="file"], select, textarea {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #e5e5e5;
            transition: all 0.3s ease;
            font-size: 16px; /* Prevent iOS zoom */
        }
        
        input[type="text"]:focus, select:focus, textarea:focus {
            background: rgba(255, 255, 255, 0.08);
            border-color: #3b82f6;
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* Dropdown option styles for better readability */
        select option {
            background: #1f1f1f;
            color: #e5e5e5;
            padding: 8px;
        }

        /* Modern button styles */
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #60a5fa);
            border: none;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
        }
        
        .btn-primary:disabled {
            background: #374151;
            opacity: 0.5;
        }
        
        /* Modern checkbox/radio styles */
        input[type="checkbox"], input[type="radio"] {
            appearance: none;
            width: 20px;
            height: 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.2);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            min-width: 20px;
            min-height: 20px;
        }
        
        input[type="checkbox"] {
            border-radius: 6px;
        }
        
        input[type="radio"] {
            border-radius: 50%;
        }
        
        input[type="checkbox"]:checked, input[type="radio"]:checked {
            background: linear-gradient(135deg, #3b82f6, #60a5fa);
            border-color: transparent;
        }
        
        input[type="checkbox"]:checked::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 14px;
        }
        
        input[type="radio"]:checked::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
        }
        
        /* Label hover effects */
        label:hover input[type="checkbox"], label:hover input[type="radio"] {
            border-color: rgba(59, 130, 246, 0.5);
        }
        
        /* Upload area styles */
        .upload-area {
            background: rgba(255, 255, 255, 0.02);
            border: 2px dashed rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        
        .upload-area:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(59, 130, 246, 0.5);
        }
        
        .upload-area.drag-over {
            background: rgba(59, 130, 246, 0.1);
            border-color: #3b82f6;
        }
        
        /* Dark mode text colors */
        .text-gray-500 { color: #9ca3af !important; }
        .text-gray-600 { color: #9ca3af !important; }
        .text-gray-700 { color: #d1d5db !important; }
        .text-gray-800 { color: #e5e7eb !important; }
        
        /* Dark mode backgrounds */
        .bg-gray-50 { background-color: rgba(255, 255, 255, 0.05) !important; }
        .bg-gray-100 { background-color: rgba(255, 255, 255, 0.08) !important; }
        .bg-white { background-color: transparent !important; }
        
        /* Progress bar dark mode */
        .bg-gray-200 { background-color: rgba(255, 255, 255, 0.05) !important; }
        
        /* Status colors */
        .bg-green-50 { background-color: rgba(34, 197, 94, 0.1) !important; }
        .text-green-700 { color: #4ade80 !important; }
        .bg-red-50 { background-color: rgba(239, 68, 68, 0.1) !important; }
        .text-red-700 { color: #f87171 !important; }
        .bg-blue-50 { background-color: rgba(59, 130, 246, 0.1) !important; }
        .text-blue-700 { color: #60a5fa !important; }
        
        /* Border colors */
        .border { border-color: rgba(255, 255, 255, 0.1) !important; }
        .border-gray-300 { border-color: rgba(255, 255, 255, 0.1) !important; }
        
        /* Hover states */
        .hover\:bg-gray-50:hover { background-color: rgba(255, 255, 255, 0.08) !important; }
        
        /* Base responsive styles */
        img, video {
            max-width: 100%;
            height: auto;
        }
        
        /* Ensure minimum tap target size */
        button, label {
            min-height: 44px;
        }
        
        /* Better touch scrolling */
        * {
            -webkit-overflow-scrolling: touch;
        }
        
        /* Responsive styles */
        @media (max-width: 640px) {
            .container {
                padding: 1rem;
            }
            .floating-card {
                margin: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="min-h-screen p-4 sm:p-6 md:p-8">
        <div class="text-center mb-8 sm:mb-10">
            <h1 class="text-4xl sm:text-5xl md:text-6xl font-bold mb-3 bg-gradient-to-r from-blue-400 via-purple-400 to-pink-400 bg-clip-text text-transparent">AI Room Stager</h1>
            <p class="text-gray-400 text-lg sm:text-xl mb-2">Transform your spaces with AI magic</p>
            <p class="text-xs sm:text-sm text-gray-500">Powered by Kie.ai (Gemini 2.5 Flash) • 50% Cost Savings</p>
        </div>
        
        <div class="max-w-6xl mx-auto">
            <!-- Webhook Status -->
            <div id="webhookStatus" class="mb-6 p-4 rounded floating-card hidden">
                <p class="text-sm">Cloud Version - Ready</p>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 lg:gap-8">
                <!-- Left Column: Upload and Stage -->
                <div>
                    <div class="floating-card p-6 sm:p-8">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-semibold text-gray-100">Stage a Room</h2>
                            <button onclick="clearForm()" class="text-sm px-4 py-2 bg-gray-800 hover:bg-gray-700 rounded-lg transition-colors">
                                Clear Form
                            </button>
                        </div>
                        
                        <!-- Upload Section -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium mb-3 text-gray-300">Upload Photo</label>
                            <input type="file" id="fileInput" accept="image/*" class="hidden">
                            <label for="fileInput" class="cursor-pointer upload-area rounded-lg p-8 block text-center">
                                <svg class="w-12 h-12 mx-auto mb-3 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                </svg>
                                <p class="text-gray-300 font-medium">Drop your image here or click to browse</p>
                                <p class="text-xs text-gray-500 mt-2">Supports JPG, PNG • Max 10MB</p>
                            </label>
                        </div>
                        
                        <!-- Current Image Preview -->
                        <div id="currentImagePreview" class="hidden mb-6">
                            <p class="text-sm font-medium mb-3 text-gray-300">Selected Image:</p>
                            <img id="previewImage" class="w-full h-48 object-cover rounded-lg">
                        </div>
                        
                        <!-- Space Type (Interior/Exterior) -->
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-3 text-gray-300">Space Type</label>
                            <select id="spaceType" class="w-full p-3 rounded-lg" onchange="handleSpaceTypeChange()">
                                <option value="interior">Interior Room</option>
                                <option value="exterior">Exterior/Outdoor</option>
                            </select>
                        </div>
                        
                        <!-- Transformation Type -->
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-3 text-gray-300">Transformation Type</label>
                            <select id="transformationType" class="w-full p-3 rounded-lg" onchange="handleTransformationChange()">
                                <option value="furnish">Add Furniture (Virtual Staging) - ~30 sec</option>
                                <option value="empty">Remove All Furniture - ~30 sec</option>
                                <option value="enhance">Enhance Photo Only - ~20 sec</option>
                                <option value="redesign">Redesign Existing Furniture - ~30 sec</option>
                                <option value="day_to_dusk">Convert to Evening/Dusk - ~20 sec</option>
                            </select>
                            <p id="timeEstimate" class="text-xs text-gray-500 mt-1">Estimated processing time: 2-3 minutes</p>
                        </div>
                        
                        <!-- Room Type (for interior) -->
                        <div id="roomTypeSection" class="mb-4">
                            <label class="block text-sm font-medium mb-3 text-gray-300">Room Type</label>
                            <select id="roomType" class="w-full p-3 rounded-lg">
                                <option value="living_room">Living Room</option>
                                <option value="bedroom">Bedroom</option>
                                <option value="kitchen">Kitchen</option>
                                <option value="bathroom">Bathroom</option>
                                <option value="dining_room">Dining Room</option>
                                <option value="home_office">Home Office</option>
                                <option value="kid_bedroom">Kid's Bedroom</option>
                            </select>
                        </div>
                        
                        <!-- Outdoor Type (for exterior) -->
                        <div id="outdoorTypeSection" class="mb-4 hidden">
                            <label class="block text-sm font-medium mb-3 text-gray-300">Outdoor Type</label>
                            <select id="outdoorType" class="w-full p-3 rounded-lg">
                                <option value="terrace">Terrace/Patio</option>
                                <option value="pool">Pool Area</option>
                                <option value="pergola">Pergola</option>
                            </select>
                        </div>
                        
                        <!-- Design Styles -->
                        <div id="designStyleSection" class="mb-6">
                            <label class="block text-sm font-medium mb-3 text-gray-300">Select Design Style</label>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                                <label class="flex items-center space-x-2 p-3 rounded-lg hover:bg-gray-800 cursor-pointer transition-colors">
                                    <input type="radio" name="designStyle" value="modern" class="design-radio" checked>
                                    <span class="text-sm text-gray-300">Modern</span>
                                </label>
                                <label class="flex items-center space-x-2 p-3 rounded-lg hover:bg-gray-800 cursor-pointer transition-colors">
                                    <input type="radio" name="designStyle" value="coastal" class="design-radio">
                                    <span class="text-sm text-gray-300">Coastal</span>
                                </label>
                                <label class="flex items-center space-x-2 p-3 rounded-lg hover:bg-gray-800 cursor-pointer transition-colors">
                                    <input type="radio" name="designStyle" value="midcentury" class="design-radio">
                                    <span class="text-sm text-gray-300">Mid-Century</span>
                                </label>
                                <label class="flex items-center space-x-2 p-3 rounded-lg hover:bg-gray-800 cursor-pointer transition-colors">
                                    <input type="radio" name="designStyle" value="rustic" class="design-radio">
                                    <span class="text-sm text-gray-300">Rustic</span>
                                </label>
                                <label class="flex items-center space-x-2 p-3 rounded-lg hover:bg-gray-800 cursor-pointer transition-colors">
                                    <input type="radio" name="designStyle" value="minimalist" class="design-radio">
                                    <span class="text-sm text-gray-300">Minimalist</span>
                                </label>
                                <label class="flex items-center space-x-2 p-3 rounded-lg hover:bg-gray-800 cursor-pointer transition-colors">
                                    <input type="radio" name="designStyle" value="french" class="design-radio">
                                    <span class="text-sm text-gray-300">French</span>
                                </label>
                                <label class="flex items-center space-x-2 p-3 rounded-lg hover:bg-gray-800 cursor-pointer transition-colors">
                                    <input type="radio" name="designStyle" value="bohemian" class="design-radio">
                                    <span class="text-sm text-gray-300">Bohemian</span>
                                </label>
                                <label class="flex items-center space-x-2 p-3 rounded-lg hover:bg-gray-800 cursor-pointer transition-colors">
                                    <input type="radio" name="designStyle" value="traditional" class="design-radio">
                                    <span class="text-sm text-gray-300">Traditional</span>
                                </label>
                                <label class="flex items-center space-x-2 p-3 rounded-lg hover:bg-gray-800 cursor-pointer transition-colors">
                                    <input type="radio" name="designStyle" value="farmhouse" class="design-radio">
                                    <span class="text-sm text-gray-300">Farmhouse</span>
                                </label>
                                <label class="flex items-center space-x-2 p-3 rounded-lg hover:bg-gray-800 cursor-pointer transition-colors">
                                    <input type="radio" name="designStyle" value="contemporary" class="design-radio">
                                    <span class="text-sm text-gray-300">Contemporary</span>
                                </label>
                            </div>
                        </div>
                        
                        
                        <!-- Advanced Options -->
                        <div id="advancedOptions" class="mb-6 border-t border-gray-700 pt-4">
                            <p class="text-sm font-medium mb-3 text-gray-300">Advanced Options</p>
                            
                            <!-- Flooring Option -->
                            <div id="flooringSection" class="mb-3">
                                <label class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-800 cursor-pointer transition-colors">
                                    <input type="checkbox" id="updateFlooring">
                                    <span class="text-sm text-gray-300">Update flooring</span>
                                </label>
                            </div>
                            
                            <!-- Block Decorative Elements -->
                            <div id="blockDecorSection" class="mb-3">
                                <label class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-800 cursor-pointer transition-colors">
                                    <input type="checkbox" id="blockDecorative" checked>
                                    <span class="text-sm text-gray-300">Block decorative items (plants, vases, animals)</span>
                                </label>
                            </div>
                            
                            <!-- Renovate Mode -->
                            <div id="renovateModeSection" class="mb-3">
                                <label class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-800 cursor-pointer transition-colors">
                                    <input type="checkbox" id="renovateMode" onchange="handleRenovateModeChange()">
                                    <span class="text-sm text-gray-300">Renovate Mode (enhanced AI for dramatic changes)</span>
                                </label>
                                <p class="text-xs text-gray-500 ml-9 mt-1">Uses extra AI processing for more creative results</p>
                            </div>
                        </div>
                        
                        <!-- Stage Button -->
                        <button onclick="stageCurrentRoom()" id="stageBtn" class="w-full btn-primary text-white py-4 px-6 rounded-lg font-medium disabled:cursor-not-allowed text-base">
                            Stage This Room
                        </button>
                        
                        <!-- Status -->
                        <div id="status" class="mt-4"></div>
                        
                        <!-- Progress Bar -->
                        <div id="progressBar" class="hidden mt-4">
                            <div class="w-full progress-bg rounded-full h-2">
                                <div id="progressFill" class="progress-fill h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                            </div>
                            <p id="progressText" class="text-sm text-gray-400 mt-2 text-center">Processing...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Right Column: Results -->
                <div>
                    <div class="floating-card p-6 sm:p-8">
                        <h2 class="text-2xl font-semibold mb-6 text-gray-100">Staging Results</h2>
                        <div id="resultsContainer" class="space-y-4">
                            <p class="text-gray-400 text-center py-12">No rooms staged yet. Upload a photo to get started!</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- All Staged Rooms Section -->
            <div id="allRoomsSection" class="mt-8 hidden">
                <div class="floating-card p-6 sm:p-8">
                    <h2 class="text-2xl font-semibold mb-6 text-gray-100">All Staged Rooms</h2>
                    <div id="allRoomsGrid" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let currentImageData = null;
        let stagingJobs = [];
        let currentRequestId = null;
        let pollingInterval = null;
        let lastRequestData = null;
        
        // Detect if user is on mobile device
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                   window.innerWidth < 768;
        }
        
        // Compress image to reduce upload time on mobile
        async function compressImage(base64String, maxWidth = 1920, maxHeight = 1920, quality = 0.85) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = function() {
                    let width = img.width;
                    let height = img.height;
                    
                    // Calculate new dimensions while maintaining aspect ratio
                    if (width > maxWidth || height > maxHeight) {
                        const ratio = Math.min(maxWidth / width, maxHeight / height);
                        width *= ratio;
                        height *= ratio;
                    }
                    
                    // Create canvas and draw resized image
                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Convert to base64 with compression
                    const compressedBase64 = canvas.toDataURL('image/jpeg', quality);
                    
                    // Log compression results
                    const originalSize = base64String.length;
                    const compressedSize = compressedBase64.length;
                    const savings = Math.round((1 - compressedSize / originalSize) * 100);
                    console.log(`Image compressed: ${Math.round(originalSize/1024)}KB → ${Math.round(compressedSize/1024)}KB (${savings}% smaller)`);
                    
                    resolve(compressedBase64);
                };
                img.src = base64String;
            });
        }
        
        // Show mobile-specific tips
        if (isMobileDevice()) {
            document.querySelectorAll('.mobile-tip').forEach(el => el.classList.remove('hidden'));
        }
        
        // Check API status - try config.json first as fallback
        fetch('/config.json')
            .then(res => res.json())
            .then(config => {
                const statusEl = document.getElementById('webhookStatus');
                if (config.api_status === 'ready') {
                    statusEl.innerHTML = '<p class="text-green-700">✓ Cloud Version - Ready (Static Config)</p>';
                    statusEl.classList.add('bg-green-50');
                    
                    // Try API health check anyway
                    fetch('/api/health')
                        .then(res => res.json())
                        .then(data => {
                            if (data.instantdeco_configured && data.imgbb_configured) {
                                statusEl.innerHTML = '<p class="text-green-700">✓ Cloud Version - All Systems Ready</p>';
                            }
                        })
                        .catch(() => {
                            // API blocked by auth, but config says ready, so continue
                            console.log('API requires authentication, using static config');
                        });
                }
            })
            .catch(err => {
                const statusEl = document.getElementById('webhookStatus');
                statusEl.innerHTML = '<p class="text-amber-700">⚠ Configuration loading...</p>';
                statusEl.classList.add('bg-amber-50');
            });
        
        // Clear form function
        function clearForm() {
            currentImageData = null;
            currentRequestId = null;
            document.getElementById('fileInput').value = '';
            document.getElementById('currentImagePreview').classList.add('hidden');
            document.getElementById('status').innerHTML = '';
            document.getElementById('progressBar').classList.add('hidden');
            document.getElementById('stageBtn').disabled = false;
            document.getElementById('stageBtn').textContent = 'Stage This Room';
            
            // Stop any polling
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
            }
        }
        
        // Handle space type change
        function handleSpaceTypeChange() {
            const spaceType = document.getElementById('spaceType').value;
            const roomTypeSection = document.getElementById('roomTypeSection');
            const outdoorTypeSection = document.getElementById('outdoorTypeSection');
            const transformationType = document.getElementById('transformationType');
            
            if (spaceType === 'exterior') {
                roomTypeSection.classList.add('hidden');
                outdoorTypeSection.classList.remove('hidden');
                
                // Update transformation options for exterior
                transformationType.innerHTML = `
                    <option value="outdoor">Add Outdoor Furniture - ~30 sec</option>
                    <option value="enhance">Enhance Photo Only - ~20 sec</option>
                    <option value="blue_sky">Add Blue Sky Effect - ~20 sec</option>
                    <option value="day_to_dusk">Convert to Evening/Dusk - ~20 sec</option>
                `;
            } else {
                roomTypeSection.classList.remove('hidden');
                outdoorTypeSection.classList.add('hidden');
                
                // Restore interior transformation options
                transformationType.innerHTML = `
                    <option value="furnish">Add Furniture (Virtual Staging) - ~2-3 min</option>
                    <option value="empty">Remove All Furniture - ~1-2 min</option>
                    <option value="enhance">Enhance Photo Only - ~30-60 sec</option>
                    <option value="redesign">Redesign Existing Furniture - ~2-3 min</option>
                    <option value="day_to_dusk">Convert to Evening/Dusk - ~1 min</option>
                `;
            }
            
            handleTransformationChange();
        }
        
        // Handle transformation type change
        function handleTransformationChange() {
            const transformType = document.getElementById('transformationType').value;
            const spaceType = document.getElementById('spaceType').value;
            const designStyleSection = document.getElementById('designStyleSection');
            const flooringSection = document.getElementById('flooringSection');
            const blockDecorSection = document.getElementById('blockDecorSection');
            const renovateModeSection = document.getElementById('renovateModeSection');
            const advancedOptions = document.getElementById('advancedOptions');
            const timeEstimate = document.getElementById('timeEstimate');
            const renovateMode = document.getElementById('renovateMode').checked;
            
            // Update time estimate
            const timeEstimates = {
                'furnish': '30 seconds',
                'empty': '30 seconds',
                'enhance': '20 seconds',
                'redesign': '30 seconds',
                'day_to_dusk': '20 seconds',
                'outdoor': '30 seconds',
                'blue_sky': '20 seconds',
                'renovate': '30 seconds'
            };
            
            // If renovate mode is on and using furnish, show renovate time
            const actualTransformation = (renovateMode && transformType === 'furnish') ? 'renovate' : transformType;
            timeEstimate.textContent = `Estimated processing time: ${timeEstimates[actualTransformation] || '1-2 minutes'}`;
            
            // Show/hide sections based on transformation type
            const needsDesign = ['furnish', 'redesign', 'outdoor'].includes(transformType);
            const needsFlooring = ['furnish', 'redesign'].includes(transformType) && spaceType === 'interior';
            const needsBlockDecor = ['furnish', 'redesign', 'outdoor'].includes(transformType);
            const showRenovateMode = transformType === 'furnish' && spaceType === 'interior';
            
            designStyleSection.style.display = needsDesign ? 'block' : 'none';
            flooringSection.style.display = needsFlooring ? 'block' : 'none';
            blockDecorSection.style.display = needsBlockDecor ? 'block' : 'none';
            renovateModeSection.style.display = showRenovateMode ? 'block' : 'none';
            advancedOptions.style.display = (needsFlooring || needsBlockDecor || showRenovateMode) ? 'block' : 'none';
        }
        
        // Handle renovate mode toggle
        function handleRenovateModeChange() {
            const renovateMode = document.getElementById('renovateMode').checked;
            const transformation = document.getElementById('transformationType').value;
            const status = document.getElementById('status');
            
            if (renovateMode && transformation === 'furnish') {
                status.innerHTML = '<div class="bg-blue-50 p-2 rounded text-sm"><p class="text-blue-700">Renovate Mode: Will apply enhanced AI processing for more dramatic results</p></div>';
            } else if (renovateMode) {
                status.innerHTML = '<div class="bg-gray-50 p-2 rounded text-sm"><p class="text-gray-600">Renovate Mode only works with "Add Furniture" option</p></div>';
            } else {
                status.innerHTML = '';
            }
            
            handleTransformationChange();
        }
        
        // Handle file upload
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // Clear any previous errors
            document.getElementById('status').innerHTML = '';

            const reader = new FileReader();
            reader.onload = async function(event) {
                const originalData = event.target.result;
                
                // Show preview immediately with original
                document.getElementById('previewImage').src = originalData;
                document.getElementById('currentImagePreview').classList.remove('hidden');
                
                // Compress image for faster upload
                const status = document.getElementById('status');
                status.innerHTML = '<div class="bg-blue-50 p-3 rounded mt-2"><p class="text-blue-700">Optimizing image for upload...</p></div>';
                
                try {
                    currentImageData = await compressImage(originalData);
                    status.innerHTML = '<div class="bg-green-50 p-3 rounded mt-2"><p class="text-green-700">✓ Image optimized for faster upload</p></div>';
                    setTimeout(() => status.innerHTML = '', 2000);
                } catch (error) {
                    console.error('Compression failed, using original:', error);
                    currentImageData = originalData;
                    status.innerHTML = '';
                }
            };
            reader.readAsDataURL(file);
        });

        async function stageCurrentRoom() {
            if (!currentImageData) {
                alert('Please upload a photo first');
                return;
            }
            
            const spaceType = document.getElementById('spaceType').value;
            const transformationType = document.getElementById('transformationType').value;
            const roomType = spaceType === 'interior' ? 
                document.getElementById('roomType').value : 
                document.getElementById('outdoorType').value;
            let selectedDesign = document.querySelector('input[name="designStyle"]:checked')?.value || 'modern';
            let updateFlooring = document.getElementById('updateFlooring').checked;
            let blockDecorative = document.getElementById('blockDecorative').checked;
            const renovateMode = document.getElementById('renovateMode').checked;
            
            // If renovate mode is on and transformation type is furnish, override to renovate
            const actualTransformationType = (renovateMode && transformationType === 'furnish') ? 'renovate' : transformationType;
            
            const btn = document.getElementById('stageBtn');
            const status = document.getElementById('status');
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            // Disable button and show progress
            btn.disabled = true;
            btn.innerHTML = '<span class="inline-block animate-spin mr-2">⟳</span> Processing...';
            progressBar.classList.remove('hidden');
            progressFill.style.width = '5%';
            progressText.textContent = 'Preparing image...';
            
            // Show cancel button in status
            status.innerHTML = `
                <div class="bg-blue-50 p-3 rounded mt-2 flex justify-between items-center">
                    <p class="text-blue-700">Uploading to server...</p>
                    <button onclick="cancelRequest()" class="px-3 py-1 bg-red-100 hover:bg-red-200 text-red-700 rounded text-sm">
                        Cancel
                    </button>
                </div>
            `;
            
            // Update progress after a short delay
            setTimeout(() => {
                progressFill.style.width = '15%';
                if (isMobileDevice()) {
                    progressText.textContent = 'Uploading optimized image (mobile network)...';
                } else {
                    progressText.textContent = 'Uploading image...';
                }
            }, 500);

            // If image is base64, upload to ImgBB first to get URL
            let imageUrl = currentImageData;
            if (currentImageData.startsWith('data:')) {
                progressText.textContent = 'Converting image to URL...';
                const uploadResponse = await fetch('/api/upload-temp-image', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image: currentImageData })
                });

                const uploadData = await uploadResponse.json();
                if (!uploadData.success) {
                    throw new Error(uploadData.error || 'Failed to upload image');
                }

                imageUrl = uploadData.url;
                progressFill.style.width = '25%';
            }

            // Prepare request data
            const requestData = {
                image: imageUrl,
                transformation_type: actualTransformationType,
                space_type: spaceType,
                room_type: roomType,
                design_style: selectedDesign,
                update_flooring: updateFlooring,
                block_decorative: blockDecorative
            };
            
            // Store for retry
            lastRequestData = requestData;
            
            try {
                // Check for pending task from page refresh (only resume if still processing)
                const pendingTask = localStorage.getItem('pendingKieTask');
                let data = null;

                if (pendingTask) {
                    const {taskId, timestamp} = JSON.parse(pendingTask);
                    const age = Date.now() - timestamp;

                    // If task is less than 10 minutes old, check if it's still processing
                    if (age < 600000) {
                        progressFill.style.width = '30%';
                        progressText.textContent = 'Checking previous task status...';

                        const resumeResponse = await fetch(`/api/kie-check-status?taskId=${taskId}&_t=${Date.now()}`);
                        const resumeData = await resumeResponse.json();

                        if (resumeData.status === 'processing') {
                            // Task still processing, resume polling it
                            data = { success: true, status: 'processing', taskId: taskId };
                            progressFill.style.width = '40%';
                            progressText.textContent = 'Resuming previous task...';
                        } else {
                            // Task completed or failed, clear localStorage and create new task
                            localStorage.removeItem('pendingKieTask');
                        }
                    } else {
                        // Task too old, clear it
                        localStorage.removeItem('pendingKieTask');
                    }
                }

                // If no resumed task, create a new one
                if (!data) {
                    // Update progress
                    progressFill.style.width = '30%';
                    progressText.textContent = 'AI is analyzing your room...';

                    // Call Kie.ai API endpoint (50% cheaper than Google Gemini!)
                    const response = await fetch('/api/kie-stage', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestData)
                    });

                    data = await response.json();
                }

                if (data.success && data.status === 'processing' && data.taskId) {
                    // Got task ID - start polling for completion
                    const taskId = data.taskId;
                    progressFill.style.width = '40%';
                    progressText.textContent = 'AI is generating your staged room...';

                    // Save taskId to localStorage for potential resume
                    localStorage.setItem('pendingKieTask', JSON.stringify({
                        taskId: taskId,
                        timestamp: Date.now(),
                        params: requestData
                    }));

                    // Poll for completion (max 150 attempts = 300 seconds / 5 minutes)
                    let attempts = 0;
                    const maxAttempts = 150;

                    while (attempts < maxAttempts) {
                        // Wait 2 seconds between polls
                        await new Promise(resolve => setTimeout(resolve, 2000));
                        attempts++;

                        // Update progress with contextual messages
                        const progress = 40 + (attempts / maxAttempts) * 55;
                        progressFill.style.width = `${progress}%`;

                        const elapsed = attempts * 2;
                        let message = `Processing... (${elapsed}s elapsed)`;
                        if (elapsed >= 180) {
                            message = `Still processing... (${elapsed}s) - Complex images can take 4-6 minutes`;
                        } else if (elapsed >= 120) {
                            message = `Processing... (${elapsed}s) - Almost there, this is taking longer than usual`;
                        }
                        progressText.textContent = message;

                        // Check status (add timestamp to prevent caching)
                        const statusResponse = await fetch(`/api/kie-check-status?taskId=${taskId}&_t=${Date.now()}`);
                        const statusData = await statusResponse.json();

                        if (statusData.success && statusData.status === 'completed' && statusData.images && statusData.images.length > 0) {
                            // Success! Clear pending task
                            localStorage.removeItem('pendingKieTask');

                            progressFill.style.width = '100%';
                            progressText.textContent = 'Complete!';

                            // Create job record
                            const job = {
                                transformationType: transformationType,
                                spaceType: spaceType,
                                design: selectedDesign,
                                roomType: roomType,
                                status: 'completed',
                                originalImage: currentImageData,
                                outputImages: statusData.images,
                                timestamp: Date.now()
                            };

                            stagingJobs.push(job);
                            updateResults();

                            status.innerHTML = `
                                <div class="bg-green-50 p-3 rounded mt-2">
                                    <p class="text-green-700">✓ Room staged successfully with Kie.ai! (50% cost savings)</p>
                                </div>
                            `;

                            setTimeout(() => clearForm(), 2000);
                            return;
                        } else if (statusData.status === 'failed') {
                            localStorage.removeItem('pendingKieTask');
                            throw new Error(statusData.error || 'Task failed');
                        }
                        // Status is still 'processing', continue polling
                    }

                    // If we get here, we timed out - but task may still be processing
                    throw new Error('Processing timed out after 5 minutes. The task may still be processing in the background - try clicking "Stage This Room" again in a minute to check if it completed.');

                } else if (data.success && data.images && data.images.length > 0) {
                    // Direct response (fallback for Gemini API or resumed completed task)
                    localStorage.removeItem('pendingKieTask');
                    progressFill.style.width = '100%';
                    progressText.textContent = 'Complete!';

                    const job = {
                        transformationType: transformationType,
                        spaceType: spaceType,
                        design: selectedDesign,
                        roomType: roomType,
                        status: 'completed',
                        originalImage: currentImageData,
                        outputImages: data.images,
                        timestamp: Date.now()
                    };

                    stagingJobs.push(job);
                    updateResults();

                    status.innerHTML = `
                        <div class="bg-green-50 p-3 rounded mt-2">
                            <p class="text-green-700">✓ Room staged successfully!</p>
                        </div>
                    `;

                    setTimeout(() => clearForm(), 2000);

                } else {
                    throw new Error(data.error || 'Failed to stage room');
                }
            } catch (error) {
                console.error('Error:', error);
                
                // Check if it's a rate limit error
                if (error.message && error.message.includes('wait')) {
                    status.innerHTML = `<div class="bg-yellow-50 p-3 rounded mt-2">
                        <p class="text-yellow-700 font-medium">⏳ Rate Limit Reached</p>
                        <p class="text-yellow-600 text-sm mt-1">${error.message}</p>
                        <p class="text-yellow-600 text-sm mt-1">The API has a 45-second cooldown between requests to ensure quality results.</p>
                    </div>`;
                } else {
                    status.innerHTML = `<div class="bg-red-50 p-3 rounded mt-2"><p class="text-red-700">Error: ${error.message}</p></div>`;
                }
                
                btn.disabled = false;
                btn.textContent = 'Stage This Room';
                progressBar.classList.add('hidden');
            }
        }

        // Polling removed - Gemini API returns results immediately
        
        function getTransformationLabel(type) {
            const labels = {
                'furnish': 'Virtual Staging',
                'empty': 'Furniture Removed',
                'enhance': 'Enhanced',
                'redesign': 'Redesigned',
                'day_to_dusk': 'Evening View',
                'outdoor': 'Outdoor Staging',
                'blue_sky': 'Blue Sky Effect'
            };
            return labels[type] || type;
        }
        
        function updateResults() {
            const container = document.getElementById('resultsContainer');
            const allRoomsSection = document.getElementById('allRoomsSection');
            const allRoomsGrid = document.getElementById('allRoomsGrid');
            
            // Update recent results
            container.innerHTML = '';
            const recentJobs = stagingJobs.slice(-3).reverse();
            
            recentJobs.forEach(job => {
                if (job.status === 'completed' && job.outputImages.length > 0) {
                    const jobDiv = document.createElement('div');
                    jobDiv.className = 'border rounded-lg p-3 mb-3';
                    const label = getTransformationLabel(job.transformationType);
                    
                    const compareBtn = document.createElement('button');
                    compareBtn.className = 'text-sm px-3 py-1.5 bg-purple-600 hover:bg-purple-700 text-white rounded';
                    compareBtn.textContent = 'Compare';
                    compareBtn.onclick = () => showComparison(job.originalImage, job.outputImages[0], label);

                    jobDiv.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="font-medium">${label}</h3>
                            <div class="flex gap-2" id="buttons-${stagingJobs.indexOf(job)}">
                                <button data-job-index="${stagingJobs.indexOf(job)}" class="restage-btn text-sm px-3 py-1.5 bg-green-600 hover:bg-green-700 text-white rounded">
                                    Restage
                                </button>
                                <button onclick="downloadImage('${job.outputImages[0]}')" class="text-sm px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded">
                                    Download
                                </button>
                            </div>
                        </div>
                        <div class="mt-2">
                            ${job.outputImages.map((img, idx) => `
                                <img src="${img}" class="w-full h-48 object-cover rounded cursor-pointer hover:opacity-90"
                                     onclick="showImageModal('${img}')"
                                     title="Click to view full size">
                            `).join('')}
                        </div>
                    `;

                    // Insert compare button
                    const buttonsDiv = jobDiv.querySelector(`#buttons-${stagingJobs.indexOf(job)}`);
                    if (buttonsDiv) {
                        buttonsDiv.insertBefore(compareBtn, buttonsDiv.firstChild);
                    }
                    container.appendChild(jobDiv);

                    // Add event listener to restage button
                    const restageBtn = jobDiv.querySelector('.restage-btn');
                    if (restageBtn) {
                        restageBtn.addEventListener('click', () => {
                            restageImage(job.originalImage, job.transformationType, job.roomType, job.spaceType, job.design);
                        });
                    }
                } else if (job.status === 'processing') {
                    const jobDiv = document.createElement('div');
                    jobDiv.className = 'border rounded-lg p-3 mb-3 bg-gray-50';
                    jobDiv.innerHTML = `
                        <h3 class="font-medium mb-2">Processing...</h3>
                        <div class="animate-pulse bg-gray-200 h-48 rounded"></div>
                    `;
                    container.appendChild(jobDiv);
                }
            });
            
            // Update all rooms section
            if (stagingJobs.filter(j => j.status === 'completed').length > 0) {
                allRoomsSection.classList.remove('hidden');
                allRoomsGrid.innerHTML = '';
                
                stagingJobs.filter(j => j.status === 'completed').reverse().forEach(job => {
                    const roomDiv = document.createElement('div');
                    roomDiv.className = 'bg-white rounded-lg shadow-lg p-4';
                    
                    const date = new Date(job.timestamp);
                    const timeStr = date.toLocaleTimeString();
                    const label = getTransformationLabel(job.transformationType);
                    
                    const compareGridBtn = document.createElement('button');
                    compareGridBtn.className = 'text-sm px-3 py-1.5 bg-purple-600 hover:bg-purple-700 text-white rounded';
                    compareGridBtn.textContent = 'Compare';
                    compareGridBtn.onclick = () => showComparison(job.originalImage, job.outputImages[0], label);

                    roomDiv.innerHTML = `
                        <div class="flex items-start gap-4 mb-3">
                            <img src="${job.originalImage}" class="w-24 h-24 object-cover rounded">
                            <div class="flex-1">
                                <h3 class="font-semibold">${label}</h3>
                                <p class="text-sm text-gray-600">Staged at ${timeStr}</p>
                                <div class="flex gap-2 mt-2" id="grid-buttons-${stagingJobs.indexOf(job)}">
                                    <button data-job-index="${stagingJobs.indexOf(job)}" class="restage-btn-grid text-sm px-3 py-1.5 bg-green-600 hover:bg-green-700 text-white rounded">
                                        Restage
                                    </button>
                                    <button onclick="downloadImage('${job.outputImages[0]}')" class="text-sm px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded">
                                        Download
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="mt-2">
                            ${job.outputImages.map((img, idx) => `
                                <img src="${img}" class="w-full h-32 object-cover rounded cursor-pointer hover:opacity-90 mb-2"
                                     onclick="showImageModal('${img}')">
                            `).join('')}
                        </div>
                    `;

                    // Insert compare button
                    const gridButtonsDiv = roomDiv.querySelector(`#grid-buttons-${stagingJobs.indexOf(job)}`);
                    if (gridButtonsDiv) {
                        gridButtonsDiv.insertBefore(compareGridBtn, gridButtonsDiv.firstChild);
                    }

                    allRoomsGrid.appendChild(roomDiv);

                    // Add event listener to restage button
                    const restageBtn = roomDiv.querySelector('.restage-btn-grid');
                    if (restageBtn) {
                        restageBtn.addEventListener('click', () => {
                            restageImage(job.originalImage, job.transformationType, job.roomType, job.spaceType, job.design);
                        });
                    }
                });
            }
        }
        
        // Download image function
        function downloadImage(url) {
            const link = document.createElement('a');
            link.href = url;
            link.download = 'staged-room-' + Date.now() + '.jpg';
            link.target = '_blank';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Restage image function
        function restageImage(originalImageData, transformationType, roomType, spaceType, designStyle) {
            console.log('Restage called with:', { transformationType, roomType, spaceType, designStyle });
            // Set the image data
            currentImageData = originalImageData;

            // Update preview
            const previewImage = document.getElementById('previewImage');
            previewImage.src = originalImageData;
            document.getElementById('currentImagePreview').classList.remove('hidden');

            // Pre-fill space type
            const spaceTypeSelect = document.getElementById('spaceType');
            spaceTypeSelect.value = spaceType || 'interior';
            handleSpaceTypeChange(); // Update room type options

            // Pre-fill transformation type
            setTimeout(() => {
                document.getElementById('transformationType').value = transformationType;
                handleTransformationChange(); // Update time estimate and options
            }, 100);

            // Pre-fill room type
            setTimeout(() => {
                if (spaceType === 'interior') {
                    document.getElementById('roomType').value = roomType;
                } else {
                    document.getElementById('outdoorType').value = roomType;
                }
            }, 150);

            // Set design style radio button
            setTimeout(() => {
                const designRadios = document.querySelectorAll('input[name="designStyle"]');
                designRadios.forEach(radio => {
                    if (radio.value === designStyle) {
                        radio.checked = true;
                    }
                });
            }, 200);

            // Scroll to form at top
            setTimeout(() => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }, 250);

            // Show message
            document.getElementById('status').innerHTML =
                '<div class="bg-blue-50 p-3 rounded mt-2"><p class="text-blue-700">✓ Image reloaded! Adjust settings below and click "Stage This Room" to create a new variation.</p></div>';
        }
        
        
        // Initialize form state
        handleSpaceTypeChange();
        
        // Retry last request (simplified - no polling needed)
        async function retryLastRequest() {
            if (lastRequestData) {
                // Clear status
                document.getElementById('status').innerHTML = '';

                // Re-submit with same data
                await stageCurrentRoom();
            }
        }
        
        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registered:', registration);
                    })
                    .catch(error => {
                        console.log('ServiceWorker registration failed:', error);
                    });
            });
        }

        // Handle PWA install prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevent Chrome 67 and earlier from automatically showing the prompt
            e.preventDefault();
            // Stash the event so it can be triggered later
            deferredPrompt = e;
            // Update UI to notify the user they can add to home screen
            showInstallPromotion();
        });

        function showInstallPromotion() {
            // You can add a custom install button/banner here if desired
            console.log('App can be installed');
        }

        // Image modal functions
        function showImageModal(imageUrl) {
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            modalImage.src = imageUrl;
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }

        function hideImageModal() {
            const modal = document.getElementById('imageModal');
            modal.classList.add('hidden');
            document.body.style.overflow = ''; // Restore scrolling
        }

        // Comparison modal functions
        function showComparison(originalUrl, stagedUrl, label) {
            const modal = document.getElementById('comparisonModal');
            const originalImage = document.getElementById('comparisonOriginal');
            const stagedImage = document.getElementById('comparisonStaged');
            const modalLabel = document.getElementById('comparisonLabel');

            originalImage.src = originalUrl;
            stagedImage.src = stagedUrl;
            modalLabel.textContent = label || 'Comparison';

            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function hideComparison() {
            const modal = document.getElementById('comparisonModal');
            modal.classList.add('hidden');
            document.body.style.overflow = '';
        }

        // Close modals on ESC key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                hideImageModal();
                hideComparison();
            }
        });
    </script>

    <!-- Image Modal -->
    <div id="imageModal" class="hidden fixed inset-0 bg-black bg-opacity-90 z-50 flex items-center justify-center p-4" onclick="hideImageModal()">
        <button onclick="hideImageModal()" class="absolute top-4 right-4 text-white text-4xl hover:text-gray-300 z-10">&times;</button>
        <img id="modalImage" src="" class="max-w-full max-h-full object-contain" onclick="event.stopPropagation()">
    </div>

    <!-- Comparison Modal -->
    <div id="comparisonModal" class="hidden fixed inset-0 bg-black bg-opacity-95 z-50 flex items-center justify-center p-4" onclick="hideComparison()">
        <div class="w-full max-w-7xl" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4">
                <h2 id="comparisonLabel" class="text-2xl font-bold text-white">Comparison</h2>
                <button onclick="hideComparison()" class="text-white text-4xl hover:text-gray-300">&times;</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <h3 class="text-white text-center mb-2 font-semibold">Original</h3>
                    <img id="comparisonOriginal" src="" class="w-full h-auto rounded-lg shadow-2xl object-contain max-h-[70vh]">
                </div>
                <div>
                    <h3 class="text-white text-center mb-2 font-semibold">Staged</h3>
                    <img id="comparisonStaged" src="" class="w-full h-auto rounded-lg shadow-2xl object-contain max-h-[70vh]">
                </div>
            </div>
        </div>
    </div>
</body>
</html>